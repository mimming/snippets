{% extends 'base.html' %}
<!--
# Copyright 2019 Google, Inc.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
-->

{% block content %}
    <style>
        html,
        body {
            height: 100%;
        }

        body {
            display: -ms-flexbox;
            display: flex;
            -ms-flex-align: center;
            align-items: center;
            padding-top: 40px;
            padding-bottom: 40px;
            background-color: #f5f5f5;
        }

        h1 {
            padding-top: 20px;
        }

        ul {
            text-align: left;
        }

        .form-settings-update {
            width: 100%;
            max-width: 330px;
            margin: auto;
            padding: 15px;
            font-weight: 400;
        }

        .form-settings-update:first-child {
            padding: 200px 15px 15px;
        }

        .form-settings-update .form-control {
            position: relative;
            box-sizing: border-box;
            height: auto;
            padding: 10px;
            font-size: 16px;
        }

        .form-settings-update .form-control:focus {
            z-index: 2;
        }

        .form-settings-update input[type="email"] {
            margin-bottom: -1px;
            border-bottom-right-radius: 0;
            border-bottom-left-radius: 0;
        }

        .form-settings-update input[type="password"] {
            margin-bottom: 10px;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }

    </style>
    <div class="text-center">

        <form class="form-settings-update form-first" method="post" action="/admin-settings-update">
            {% if error %}
                <div class="alert alert-danger" role="alert">
                    {{ error }}
                </div>
            {% endif %}

            <h1 class="h3 mb-3 font-weight-normal">Update your email or password:</h1>
            <label for="inputEmail" class="sr-only">Email address</label>
            <input name="email" type="email" id="inputEmail" class="form-control" value="{{ email }}"
                   placeholder="Email address" required autofocus>

            <label for="inputPassword" class="sr-only">New Password</label>
            <input type="password" id="inputPassword" class="form-control" placeholder="Password" required>
            <button class="btn btn-lg btn-primary btn-block" type="submit">Save</button>
        </form>


        <form class="form-settings-update">
            <h1 class="h3 mb-3 font-weight-normal">Or do something else:</h1>
            <button id="register-security-key" class="btn btn-lg btn-primary btn-block" type="button">Register a
                Security Key
            </button>
            <h1 class="h3 mb-3 font-weight-normal">Known security keys:</h1>
            <ul>
                <li>key 1</li>
                <li>key 2</li>
            </ul>
        </form>

    </div>

    <script>
        const make_credential_options = {{ make_credential_options | safe }};
        const regSecurityKeyStep1 = function () {
            const publicKeyCredentialCreateOptions = transformCredentialCreateOptions(make_credential_options);

            return navigator.credentials.create({'publicKey': publicKeyCredentialCreateOptions})
                .then((result) => {
                    {#newCredentialInfo = publicKeyCredentialToJSON(newCredentialInfo);#}
                    console.log(result);
                    // post it back to the server?

                })
                .catch((error) => {
                    console.log('uhoh', error);
                });
        };

        const regButton = document.getElementById("register-security-key");
        regButton.addEventListener('click', regSecurityKeyStep1)


        // TODO: inline this because ugh
        /**
         * Transforms items in the credentialCreateOptions generated on the server
         * into byte arrays expected by the navigator.credentials.create() call
         * @param {Object} credentialCreateOptionsFromServer
         */
        const transformCredentialCreateOptions = (credentialCreateOptionsFromServer) => {
            let {challenge, user} = credentialCreateOptionsFromServer;
            user.id = Uint8Array.from(
                atob(credentialCreateOptionsFromServer.user.id), c => c.charCodeAt(0));

            challenge = Uint8Array.from(
                atob(credentialCreateOptionsFromServer.challenge), c => c.charCodeAt(0));

            const transformedCredentialCreateOptions = Object.assign(
                {}, credentialCreateOptionsFromServer,
                {challenge, user});

            return transformedCredentialCreateOptions;
        }


    </script>


{% endblock %}
