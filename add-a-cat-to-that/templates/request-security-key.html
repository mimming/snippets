{% extends 'base.html' %}
<!--
# Copyright 2019 Google, Inc.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
-->

{% block content %}
<style>
  html,
  body {
    height: 100%;
  }

  body {
    display: -ms-flexbox;
    display: flex;
    -ms-flex-align: center;
    align-items: center;
    padding-top: 40px;
    padding-bottom: 40px;
    background-color: #f5f5f5;
  }

  .form-signin {
    width: 100%;
    max-width: 330px;
    margin: auto;
    padding: 200px 15px 15px;
    font-weight: 400;
  }

  .form-signin .form-control {
    position: relative;
    box-sizing: border-box;
    height: auto;
    padding: 10px;
    font-size: 16px;
  }

  .form-signin .form-control:focus {
    z-index: 2;
  }

  .form-signin input[type="email"] {
    margin-bottom: -1px;
    border-bottom-right-radius: 0;
    border-bottom-left-radius: 0;
  }

  .form-signin input[type="password"] {
    margin-bottom: 10px;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
  }
</style>
<div class="text-center">

  <form id="form-signin" class="form-signin" method="post" action="/verify-security-key-result">
    {% if error %}
    <div class="alert alert-danger" role="alert" >
      {{ error | safe }}
    </div>
    {% endif %}

    <h1 class="h3 mb-3 font-weight-normal">Tap your security key.</h1>
    <input type="hidden" id="assertionClientExtensions" name="assertionClientExtensions">
    <input type="hidden" id="authData" name="authData">
    <input type="hidden" id="clientData" name="clientData">
    <input type="hidden" id="id" name="id">
    <input type="hidden" id="rawId" name="rawId">
    <input type="hidden" id="signature" name="signature">
    <input type="hidden" id="type" name="type">
  </form>

</div>
<script src="/static/bower_components/base64-js/base64js.min.js"></script>
<script>

  /**
   * Taken from Duo Labs' sample code for the Python WebAuthn client library
   */
  const transformCredentialRequestOptions = (credentialRequestOptionsFromServer) => {
    let {challenge, allowCredentials} = credentialRequestOptionsFromServer;

    challenge = Uint8Array.from(
        atob(challenge), c => c.charCodeAt(0));

    allowCredentials = allowCredentials.map(credentialDescriptor => {
      let {id} = credentialDescriptor;
      id = id.replace(/\_/g, "/").replace(/\-/g, "+");
      id = Uint8Array.from(atob(id), c => c.charCodeAt(0));
      return Object.assign({}, credentialDescriptor, {id});
    });

    const transformedCredentialRequestOptions = Object.assign(
        {},
        credentialRequestOptionsFromServer,
        {challenge, allowCredentials});

    return transformedCredentialRequestOptions;
  };

  /**
   * Taken from Duo Labs' sample code for the Python WebAuthn client library
   *
   * Encodes the binary data in the assertion into strings for posting to the server.
   * @param {PublicKeyCredential} newAssertion
   */
  const transformAssertionForServer = (newAssertion) => {
    const authData = new Uint8Array(newAssertion.response.authenticatorData);
    const clientDataJSON = new Uint8Array(newAssertion.response.clientDataJSON);
    const rawId = new Uint8Array(newAssertion.rawId);
    const sig = new Uint8Array(newAssertion.response.signature);
    const assertionClientExtensions = newAssertion.getClientExtensionResults();

    return {
      id: newAssertion.id,
      rawId: b64enc(rawId),
      type: newAssertion.type,
      authData: b64RawEnc(authData),
      clientData: b64RawEnc(clientDataJSON),
      signature: hexEncode(sig),
      assertionClientExtensions: JSON.stringify(assertionClientExtensions)
    };
  };

  /**
   * Taken from Duo Labs' sample code for the Python WebAuthn client library
   */
  function b64enc(buf) {
    return base64js.fromByteArray(buf)
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=/g, "");
  }

  /**
   * Taken from Duo Labs' sample code for the Python WebAuthn client library
   */
  function hexEncode(buf) {
    return Array.from(buf)
        .map(function(x) {
          return ("0" + x.toString(16)).substr(-2);
        })
        .join("");
  }

  /**
   * Taken from Duo Labs' sample code for the Python WebAuthn client library
   */
   function b64RawEnc(buf) {
    return base64js.fromByteArray(buf)
        .replace(/\+/g, "-")
        .replace(/\//g, "_");
  }

  const checkSecurityKey = async () => {
    const assertionOptions = {{ assertion_options | safe }}

    console.log(assertionOptions);

    encodedCredentialRequestOptions = transformCredentialRequestOptions(assertionOptions);

    assertion = await navigator.credentials.get({
      publicKey: encodedCredentialRequestOptions,
    });

    const encodedAssertion = transformAssertionForServer(assertion);

    console.log(encodedAssertion);

    // populate the form and submit it
    document.getElementById('assertionClientExtensions').value = encodedAssertion.assertionClientExtensions;
    document.getElementById('authData').value = encodedAssertion.authData;
    document.getElementById('clientData').value = encodedAssertion.clientData;
    document.getElementById('id').value = encodedAssertion.id;
    document.getElementById('rawId').value = encodedAssertion.rawId;
    document.getElementById('signature').value = encodedAssertion.signature;
    document.getElementById('signature').type = encodedAssertion.type;

    document.getElementById('form-signin').submit();


  };

  checkSecurityKey();

</script>
{% endblock %}
